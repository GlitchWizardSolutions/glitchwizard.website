<?php
/* 
 * Invoice Table Transfer System
 * 
 * SYSTEM: GWS Universal Hybrid App - Admin Panel
 * FILE: invoice_table_transfer.php
 * LOCATION: /public_html/admin/invoice_system/
 * PURPOSE: Import and export invoice and invoice category data in multiple formats (CSV, JSON, XML, TXT)
 * 
 * FILE RELATIONSHIP:
 * This file integrates with:
 * - Database connection system
 * - User authentication system
 * - File system operations
 * - Data validation system
 * 
 * HOW IT WORKS:
 * 1. Provides tabbed interface for import/export operations
 * 2. Handles file uploads and data validation
 * 3. Processes data format conversions
 * 4. Manages database import/export operations
 * 5. Implements security measures for data handling
 * 
 * CREATED: 2025-08-10
 * UPDATED: 2025-08-10
 * VERSION: 1.0
 * PRODUCTION: YES
 * 
 * FEATURES:
 * Multi-format data export (CSV, JSON, XML, TXT)
 * Secure file upload handling
 * Data validation and sanitization
 * Progress tracking for large transfers
 * Error logging and reporting
 * Tabbed user interface for clients and poll collections
 * Bootstrap 5 styling
 */

include '../assets/includes/main.php';
// Remove the time limit and file size limit
set_time_limit(0);
ini_set('post_max_size', '0');
ini_set('upload_max_filesize', '0');

// Handle Clients Import form submission
if (isset($_FILES['clients_file'], $_POST['clients_import']) && !empty($_FILES['clients_file']['tmp_name'])) {
    // check type
    $type = pathinfo($_FILES['clients_file']['name'], PATHINFO_EXTENSION);
    $data = [];
    if ($type == 'csv') {
        $file = fopen($_FILES['clients_file']['tmp_name'], 'r');
        $header = fgetcsv($file);
        while ($row = fgetcsv($file)) {
            $data[] = array_combine($header, $row);
        }
        fclose($file);
    } elseif ($type == 'json') {
        $data = json_decode(file_get_contents($_FILES['clients_file']['tmp_name']), true);
    } elseif ($type == 'xml') {
        $xml = simplexml_load_file($_FILES['clients_file']['tmp_name']);
        $data = json_decode(json_encode($xml), true)['item'];
    } elseif ($type == 'txt') {
        $file = fopen($_FILES['clients_file']['tmp_name'], 'r');
        while ($row = fgetcsv($file)) {
            $data[] = $row;
        }
        fclose($file);
    }
    // insert into database
    if (isset($data) && !empty($data)) {    
        $i = 0;   
        foreach ($data as $k => $row) {
            // convert array to question marks for prepared statements
            $values = array_fill(0, count($row), '?');
            $values = implode(',', $values);
            // Convert date to MySQL format, if you have more datetime columns, add them here
            if (isset($row['created'])) {
                $row['created'] = date('Y-m-d H:i', strtotime(str_replace('/','-', $row['created'])));
            }
            if (isset($row['start_date'])) {
                $row['start_date'] = date('Y-m-d H:i', strtotime(str_replace('/','-', $row['start_date'])));
            }
            if (isset($row['end_date'])) {
                $row['end_date'] = date('Y-m-d H:i', strtotime(str_replace('/','-', $row['end_date'])));
            }
            // insert into database
            // tip: if you want to update existing records, use INSERT ... ON DUPLICATE KEY UPDATE instead
            $stmt = $pdo->prepare('INSERT IGNORE INTO invoice_clients VALUES (' . $values . ')');
            $stmt->execute(array_values($row));
            $i += $stmt->rowCount();
        }
        header('Location: allclients.php?success_msg=4&imported=' . $i);
        exit;
    }
}

// Handle Clients Collections Import form submission
if (isset($_FILES['invoice_file'], $_POST['collections_import']) && !empty($_FILES['invoice_file']['tmp_name'])) {
    // check type
    $type = pathinfo($_FILES['invoice_file']['name'], PATHINFO_EXTENSION);
    $data = [];
    if ($type == 'csv') {
        $file = fopen($_FILES['invoice_file']['tmp_name'], 'r');
        $header = fgetcsv($file);
        while ($row = fgetcsv($file)) {
            $data[] = array_combine($header, $row);
        }
        fclose($file);
    } elseif ($type == 'json') {
        $data = json_decode(file_get_contents($_FILES['invoice_file']['tmp_name']), true);
    } elseif ($type == 'xml') {
        $xml = simplexml_load_file($_FILES['invoice_file']['tmp_name']);
        $data = json_decode(json_encode($xml), true)['item'];
    } elseif ($type == 'txt') {
        $file = fopen($_FILES['invoice_file']['tmp_name'], 'r');
        while ($row = fgetcsv($file)) {
            $data[] = $row;
        }
        fclose($file);
    }
    // insert into database
    if (isset($data) && !empty($data)) {    
        $i = 0;   
        foreach ($data as $k => $row) {
            // convert array to question marks for prepared statements
            $values = array_fill(0, count($row), '?');
            $values = implode(',', $values);
            // Convert date to MySQL format, if you have more datetime columns, add them here
            if (isset($row['created'])) {
                $row['created'] = date('Y-m-d H:i', strtotime(str_replace('/','-', $row['created'])));
            }
            // insert into database
            // tip: if you want to update existing records, use INSERT ... ON DUPLICATE KEY UPDATE instead
            $stmt = $pdo->prepare('INSERT IGNORE INTO invoice_clients_collections VALUES (' . $values . ')');
            $stmt->execute(array_values($row));
            $i += $stmt->rowCount();
        }
        header('Location: collections.php?success_msg=4&imported=' . $i);
        exit;
    }
}

// Handle Clients Export form submission
if (isset($_POST['clients_export_type'])) {
    // Get all clients
    $result = $pdo->query('SELECT * FROM invoice_clients ORDER BY id ASC');
    $clients = [];
    $columns = [];
    // Fetch all records into an associative array
    if ($result->rowCount() > 0) {
        // Fetch column names
        for ($i = 0; $i < $result->columnCount(); $i++) {
            $columns[] = $result->getColumnMeta($i)['name'];
        }
        // Fetch associative array
        while ($row = $result->fetch(PDO::FETCH_ASSOC)) {
            $clients[] = $row;
        }    
    }
    // Convert to CSV
    if ($_POST['clients_export_type'] == 'csv') {
        $filename = 'clients.csv';
        $fp = fopen('php://output', 'w');
        header('Content-type: application/csv');
        header('Content-Disposition: attachment; filename=' . $filename);
        fputcsv($fp,  $columns);
        foreach ($clients as $poll) {
            fputcsv($fp, $poll);
        }
        fclose($fp);
        exit;
    }
    // Convert to TXT
    if ($_POST['clients_export_type'] == 'txt') {
        $filename = 'clients.txt';
        $fp = fopen('php://output', 'w');
        header('Content-type: application/txt');
        header('Content-Disposition: attachment; filename=' . $filename);
        fwrite($fp, implode(',', $columns) . PHP_EOL);
        foreach ($clients as $poll) {
            $line = '';
            foreach ($poll as $key => $value) {
                if (is_string($value)) {
                    $value = '"' . str_replace('"', '\"', $value) . '"';
                }
                $line .= $value . ',';
            }
            $line = rtrim($line, ',') . PHP_EOL;
            fwrite($fp, $line);
        }
        fclose($fp);
        exit;
    }
    // Convert to JSON
    if ($_POST['clients_export_type'] == 'json') {
        $filename = 'clients.json';
        $fp = fopen('php://output', 'w');
        header('Content-type: application/json');
        header('Content-Disposition: attachment; filename=' . $filename);
        fwrite($fp, json_encode($clients));
        fclose($fp);
        exit;
    }
    // Convert to XML
    if ($_POST['clients_export_type'] == 'xml') {
        $filename = 'clients.xml';
        $fp = fopen('php://output', 'w');
        header('Content-type: application/xml');
        header('Content-Disposition: attachment; filename=' . $filename);
        fwrite($fp, '<?xml version="1.0" encoding="UTF-8"?>' . PHP_EOL);
        fwrite($fp, '<clients>' . PHP_EOL);
        foreach ($clients as $poll) {
            fwrite($fp, '    <poll>' . PHP_EOL);
            foreach ($poll as $key => $value) {
                fwrite($fp, '        <' . $key . '>' . htmlspecialchars($value) . '</' . $key . '>' . PHP_EOL);
            }
            fwrite($fp, '    </poll>' . PHP_EOL);
        }
        fwrite($fp, '</clients>' . PHP_EOL);
        fclose($fp);
        exit;
    }
}

// Handle Clients Collections Export form submission
if (isset($_POST['collections_export_type'])) {
    // Get all invoice_clients_collections
    $result = $pdo->query('SELECT * FROM invoice_clients_collections ORDER BY id ASC');
    $clients_collections = [];
    $columns = [];
    // Fetch all records into an associative array
    if ($result->rowCount() > 0) {
        // Fetch column names
        for ($i = 0; $i < $result->columnCount(); $i++) {
            $columns[] = $result->getColumnMeta($i)['name'];
        }
        // Fetch associative array
        while ($row = $result->fetch(PDO::FETCH_ASSOC)) {
            $clients_collections[] = $row;
        }    
    }
    // Convert to CSV
    if ($_POST['collections_export_type'] == 'csv') {
        $filename = 'clients_collections.csv';
        $fp = fopen('php://output', 'w');
        header('Content-type: application/csv');
        header('Content-Disposition: attachment; filename=' . $filename);
        fputcsv($fp,  $columns);
        foreach ($clients_collections as $clients_collection) {
            fputcsv($fp, $clients_collection);
        }
        fclose($fp);
        exit;
    }
    // Convert to TXT
    if ($_POST['collections_export_type'] == 'txt') {
        $filename = 'clients_collections.txt';
        $fp = fopen('php://output', 'w');
        header('Content-type: application/txt');
        header('Content-Disposition: attachment; filename=' . $filename);
        fwrite($fp, implode(',', $columns) . PHP_EOL);
        foreach ($clients_collections as $clients_collection) {
            $line = '';
            foreach ($clients_collection as $key => $value) {
                if (is_string($value)) {
                    $value = '"' . str_replace('"', '\"', $value) . '"';
                }
                $line .= $value . ',';
            }
            $line = rtrim($line, ',') . PHP_EOL;
            fwrite($fp, $line);
        }
        fclose($fp);
        exit;
    }
    // Convert to JSON
    if ($_POST['collections_export_type'] == 'json') {
        $filename = 'clients_collections.json';
        $fp = fopen('php://output', 'w');
        header('Content-type: application/json');
        header('Content-Disposition: attachment; filename=' . $filename);
        fwrite($fp, json_encode($clients_collections));
        fclose($fp);
        exit;
    }
    // Convert to XML
    if ($_POST['collections_export_type'] == 'xml') {
        $filename = 'clients_collections.xml';
        $fp = fopen('php://output', 'w');
        header('Content-type: application/xml');
        header('Content-Disposition: attachment; filename=' . $filename);
        fwrite($fp, '<?xml version="1.0" encoding="UTF-8"?>' . PHP_EOL);
        fwrite($fp, '<clients_collections>' . PHP_EOL);
        foreach ($clients_collections as $clients_collection) {
            fwrite($fp, '    <clients_collection>' . PHP_EOL);
            foreach ($clients_collection as $key => $value) {
                fwrite($fp, '        <' . $key . '>' . htmlspecialchars($value) . '</' . $key . '>' . PHP_EOL);
            }
            fwrite($fp, '    </clients_collection>' . PHP_EOL);
        }
        fwrite($fp, '</clients_collections>' . PHP_EOL);
        fclose($fp);
        exit;
    }
}
?>

<?=template_admin_header('Import/Export Invoices Data', 'invoices', 'transfer')?>

<div class="content-title mb-4">
    <div class="title">
        <div class="icon">
            <svg width="18" height="18" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512">
                <path d="M0 64C0 28.7 28.7 0 64 0H224V128c0 17.7 14.3 32 32 32H384V448c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V64zm384 64H256V0L384 128zM176 352h24c30.9 0 56 25.1 56 56s-25.1 56-56 56H176c-8.8 0-16-7.2-16-16V368c0-8.8 7.2-16 16-16zm24 80c13.3 0 24-10.7 24-24s-10.7-24-24-24H192v48h8zm72-64c0-8.8 7.2-16 16-16h24c26.5 0 48 21.5 48 48v32c0 26.5-21.5 48-48 48H288c-8.8 0-16-7.2-16-16V352zm32 64h8c8.8 0 16-7.2 16-16V384c0-8.8-7.2-16-16-16h-8v48zM448 352c8.8 0 16 7.2 16 16s-7.2 16-16 16H424v16h24c8.8 0 16 7.2 16 16s-7.2 16-16 16H424v16c0 8.8-7.2 16-16 16s-16-7.2-16-16V368c0-8.8 7.2-16 16-16h40z" />
            </svg>
        </div>
        <div class="txt">
            <h2>Import/Export Invoice Data</h2>
            <p>Import clients and collection data from files or export existing data to various formats.</p>
        </div>
    </div>
</div>

<div class="content-header responsive-flex-column">
    <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-start; margin-bottom: 18px;">
        <a href="invoices.php" class="btn btn-outline-secondary" style="min-width: 110px;">
            <span style="display: inline-flex; align-items: center; vertical-align: middle;">
                <svg class="icon-left" width="14" height="14" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"
                    style="color:#6c757d;fill:#6c757d;display:inline-block;vertical-align:middle;margin-right:6px;">
                    <path d="M9.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.2 288 416 288c17.7 0 32-14.3 32-32s-14.3-32-32-32l-306.7 0L214.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z" />
                </svg>
                Back to Invoices
            </span>
        </a>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h6 class="card-title mb-0">
            <i class="fas fa-exchange-alt me-2"></i>Data Transfer Center
        </h6>
        <p class="text-muted mb-0 mt-1">Import or export client and collection data using the tabs below</p>
    </div>
    <div class="card-body">
        <!-- Tab Navigation -->
        <div class="tab-nav" role="tablist" aria-label="Invoice data transfer options">
            <button class="tab-btn active" 
                role="tab"
                aria-selected="true"
                aria-controls="export-clients-tab"
                id="export-clients-tab-btn"
                onclick="openTab(event, 'export-clients-tab')">
                Export Clients
            </button>
            <button class="tab-btn" 
                role="tab"
                aria-selected="false"
                aria-controls="import-clients-tab"
                id="import-clients-tab-btn"
                onclick="openTab(event, 'import-clients-tab')">
                Import Clients
            </button>
            <button class="tab-btn" 
                role="tab"
                aria-selected="false"
                aria-controls="export-collections-tab"
                id="export-collections-tab-btn"
                onclick="openTab(event, 'export-collections-tab')">
                Export Collections
            </button>
            <button class="tab-btn" 
                role="tab"
                aria-selected="false"
                aria-controls="import-collections-tab"
                id="import-collections-tab-btn"
                onclick="openTab(event, 'import-collections-tab')">
                Import Collections
            </button>
        </div>

        <!-- Export Clients Tab Content -->
        <div id="export-clients-tab" 
            class="tab-content active" 
            role="tabpanel"
            aria-labelledby="export-clients-tab-btn">
            
            <div class="form responsive-width-100">
                <h3 id="export-clients-title">Export Clients Data</h3>
                <p id="export-clients-desc">Download all clients data in your preferred format.</p>

                <form action="" method="post">
                    <div class="form-group">
                        <label for="clients_export_type">
                            <span class="required" aria-hidden="true">*</span> 
                            File Type
                            <span class="sr-only">(required)</span>
                        </label>
                        <select id="clients_export_type" 
                            name="clients_export_type" 
                            required 
                            aria-required="true"
                            aria-describedby="clients-export-type-desc">
                            <option value="csv">CSV (Comma Separated Values)</option>
                            <option value="txt">TXT (Text File)</option>
                            <option value="json">JSON (JavaScript Object Notation)</option>
                            <option value="xml">XML (Extensible Markup Language)</option>
                        </select>
                        <div id="clients-export-type-desc" class="form-text">Choose the format for your exported clients data file.</div>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" name="submit" class="btn btn-success">
                            <svg width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" style="margin-right: 6px;">
                                <path d="M288 32c0-17.7-14.3-32-32-32s-32 14.3-32 32V274.7l-73.4-73.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l128 128c12.5 12.5 32.8 12.5 45.3 0l128-128c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L288 274.7V32zM64 352c-35.3 0-64 28.7-64 64v32c0 35.3 28.7 64 64 64H448c35.3 0 64-28.7 64-64V416c0-35.3-28.7-64-64-64H346.5l-45.3 45.3c-25 25-65.5 25-90.5 0L165.5 352H64zm368 56a24 24 0 1 1 0 48 24 24 0 1 1 0-48z" />
                            </svg>
                            Export Clients
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Import Clients Tab Content -->
        <div id="import-clients-tab" 
            class="tab-content"
            role="tabpanel"
            aria-labelledby="import-clients-tab-btn">
            
            <div class="form responsive-width-100">
                <h3 id="import-clients-title">Import Clients Data</h3>
                <p id="import-clients-desc">Upload a file containing clients data to import into the system.</p>

                <form action="" method="post" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="clients_file">
                            <span class="required" aria-hidden="true">*</span> 
                            File Upload
                            <span class="sr-only">(required)</span>
                        </label>
                        <input type="file" 
                            name="clients_file" 
                            id="clients_file" 
                            accept=".csv,.json,.xml,.txt" 
                            required
                            aria-required="true"
                            aria-describedby="clients-file-desc">
                        <div id="clients-file-desc" class="form-text">Select a data file to import clients information.</div>
                    </div>

                    <div class="alert alert-info">
                        <h6 class="alert-heading">
                            <svg width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" style="margin-right: 6px;">
                                <path d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM216 336h24V272H216c-13.3 0-24-10.7-24-24s10.7-24 24-24h48c13.3 0 24 10.7 24 24v88h8c13.3 0 24 10.7 24 24s-10.7 24-24 24H216c-13.3 0-24-10.7-24-24s10.7-24 24-24zm40-208a32 32 0 1 1 0 64 32 32 0 1 1 0-64z" />
                            </svg>
                            Supported File Formats
                        </h6>
                        <ul class="mb-0">
                            <li><strong>CSV:</strong> Comma-separated values with header row</li>
                            <li><strong>JSON:</strong> Array of clients objects</li>
                            <li><strong>XML:</strong> Structured XML with clients elements</li>
                            <li><strong>TXT:</strong> Tab or comma-delimited text file</li>
                        </ul>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" name="clients_import" class="btn btn-primary">
                            <svg width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" style="margin-right: 6px;">
                                <path d="M288 109.3V352c0 17.7-14.3 32-32 32s-32-14.3-32-32V109.3l-73.4 73.4c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3l128-128c12.5-12.5 32.8 12.5 45.3 0l128 128c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L288 109.3zM64 352H192c0 35.3 28.7 64 64 64s64-28.7 64-64H448c35.3 0 64 28.7 64 64v32c0 35.3 28.7 64-64 64H64c-35.3 0-64-28.7-64-64V416c0-35.3 28.7-64 64-64zM432 456a24 24 0 1 0 0-48 24 24 0 1 0 0 48z" />
                            </svg>
                            Import Clients
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Export Collections Tab Content -->
        <div id="export-collections-tab" 
            class="tab-content"
            role="tabpanel"
            aria-labelledby="export-collections-tab-btn">
            
            <div class="form responsive-width-100">
                <h3 id="export-collections-title">Export Collections Data</h3>
                <p id="export-collections-desc">Download all collections data in your preferred format.</p>

                <form action="" method="post">
                    <div class="form-group">
                        <label for="collections_export_type">
                            <span class="required" aria-hidden="true">*</span> 
                            File Type
                            <span class="sr-only">(required)</span>
                        </label>
                        <select id="collections_export_type" 
                            name="collections_export_type" 
                            required 
                            aria-required="true"
                            aria-describedby="collections-export-type-desc">
                            <option value="csv">CSV (Comma Separated Values)</option>
                            <option value="txt">TXT (Text File)</option>
                            <option value="json">JSON (JavaScript Object Notation)</option>
                            <option value="xml">XML (Extensible Markup Language)</option>
                        </select>
                        <div id="collections-export-type-desc" class="form-text">Choose the format for your exported collections data file.</div>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" name="submit" class="btn btn-success">
                            <svg width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" style="margin-right: 6px;">
                                <path d="M288 32c0-17.7-14.3-32-32-32s-32 14.3-32 32V274.7l-73.4-73.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l128 128c12.5 12.5 32.8 12.5 45.3 0l128-128c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L288 274.7V32zM64 352c-35.3 0-64 28.7-64 64v32c0 35.3 28.7 64 64 64H448c35.3 0 64-28.7 64-64V416c0-35.3-28.7-64-64-64H346.5l-45.3 45.3c-25 25-65.5 25-90.5 0L165.5 352H64zm368 56a24 24 0 1 1 0 48 24 24 0 1 1 0-48z" />
                            </svg>
                            Export Collections
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Import Collections Tab Content -->
        <div id="import-collections-tab" 
            class="tab-content"
            role="tabpanel"
            aria-labelledby="import-collections-tab-btn">
            
            <div class="form responsive-width-100">
                <h3 id="import-collections-title">Import Collections Data</h3>
                <p id="import-collections-desc">Upload a file containing collections data to import into the system.</p>

                <form action="" method="post" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="invoice_file">
                            <span class="required" aria-hidden="true">*</span> 
                            File Upload
                            <span class="sr-only">(required)</span>
                        </label>
                        <input type="file" 
                            name="invoice_file" 
                            id="invoice_file" 
                            accept=".csv,.json,.xml,.txt" 
                            required
                            aria-required="true"
                            aria-describedby="invoice-file-desc">
                        <div id="invoice-file-desc" class="form-text">Select a data file to import collections information.</div>
                    </div>

                    <div class="alert alert-info">
                        <h6 class="alert-heading">
                            <svg width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" style="margin-right: 6px;">
                                <path d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM216 336h24V272H216c-13.3 0-24-10.7-24-24s10.7-24 24-24h48c13.3 0 24 10.7 24 24v88h8c13.3 0 24 10.7 24 24s-10.7 24-24 24H216c-13.3 0-24-10.7-24-24s10.7-24 24-24zm40-208a32 32 0 1 1 0 64 32 32 0 1 1 0-64z" />
                            </svg>
                            Supported File Formats
                        </h6>
                        <ul class="mb-0">
                            <li><strong>CSV:</strong> Comma-separated values with header row</li>
                            <li><strong>JSON:</strong> Array of collections objects</li>
                            <li><strong>XML:</strong> Structured XML with collections elements</li>
                            <li><strong>TXT:</strong> Tab or comma-delimited text file</li>
                        </ul>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" name="collections_import" class="btn btn-primary">
                            <svg width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" style="margin-right: 6px;">
                                <path d="M288 109.3V352c0 17.7-14.3 32-32 32s-32-14.3-32-32V109.3l-73.4 73.4c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3l128-128c12.5-12.5 32.8 12.5 45.3 0l128 128c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L288 109.3zM64 352H192c0 35.3 28.7 64 64 64s64-28.7 64-64H448c35.3 0 64 28.7 64 64v32c0 35.3 28.7 64-64 64H64c-35.3 0-64-28.7-64-64V416c0-35.3 28.7-64 64-64zM432 456a24 24 0 1 0 0-48 24 24 0 1 0 0 48z" />
                            </svg>
                            Import Collections
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    function openTab(evt, tabName) {
        // Declare variables
        var i, tabcontent, tablinks;

        // Get all elements with class="tab-content" and hide them
        tabcontent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].classList.remove("active");
        }

        // Get all elements with class="tab-btn" and remove the class "active"
        tablinks = document.getElementsByClassName("tab-btn");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].classList.remove("active");
            tablinks[i].setAttribute("aria-selected", "false");
        }

        // Show the current tab, and add an "active" class to the button that opened the tab
        document.getElementById(tabName).classList.add("active");
        evt.currentTarget.classList.add("active");
        evt.currentTarget.setAttribute("aria-selected", "true");
    }
</script>

<?= template_admin_footer() ?>
        <h3 class="card-title mb-0">
            <i class="fas fa-exchange-alt me-2"></i>Data Transfer Center
        </h3>
        <p class="text-muted mb-0 mt-1">Import or export client and collection data using the tabs below</p>
    </div>
    <div class="card-body">
        <!-- Tab Navigation -->
        <div class="tab-nav" role="tablist" aria-label="Invoice data transfer options">
            <button class="tab-btn active" 
                role="tab"
                aria-selected="true"
                aria-controls="export-clients-tab"
                id="export-clients-tab-btn"
                onclick="openTab(event, 'export-clients-tab')">
                Export Clients
            </button>
            <button class="tab-btn" 
                role="tab"
                aria-selected="false"
                aria-controls="import-clients-tab"
                id="import-clients-tab-btn"
                onclick="openTab(event, 'import-clients-tab')">
                Import Clients
            </button>
            <button class="tab-btn" 
                role="tab"
                aria-selected="false"
                aria-controls="export-collections-tab"
                id="export-collections-tab-btn"
                onclick="openTab(event, 'export-collections-tab')">
                Export Collections
            </button>
            <button class="tab-btn" 
                role="tab"
                aria-selected="false"
                aria-controls="import-collections-tab"
                id="import-collections-tab-btn"
                onclick="openTab(event, 'import-collections-tab')">
                Import Collections
            </button>
        </div>

        <!-- Export Clients Tab Content -->
        <div id="export-clients-tab" 
            class="tab-content active" 
            role="tabpanel"
            aria-labelledby="export-clients-tab-btn">
            
            <div class="form responsive-width-100">
                <h3 id="export-clients-title">Export Clients Data</h3>
                <p id="export-clients-desc">Download all clients data in your preferred format.</p>

                <form action="" method="post">
                    <div class="form-group">
                        <label for="clients_export_type">
                            <span class="required" aria-hidden="true">*</span> 
                            File Type
                            <span class="sr-only">(required)</span>
                        </label>
                        <select id="clients_export_type" 
                            name="clients_export_type" 
                            required 
                            aria-required="true"
                            aria-describedby="clients-export-type-desc">
                            <option value="csv">CSV (Comma Separated Values)</option>
                            <option value="txt">TXT (Text File)</option>
                            <option value="json">JSON (JavaScript Object Notation)</option>
                            <option value="xml">XML (Extensible Markup Language)</option>
                        </select>
                        <div id="clients-export-type-desc" class="form-text">Choose the format for your exported clients data file.</div>
                    </div>
                    
                        <button type="submit" name="submit" class="btn btn-success">
                            <svg width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" style="margin-right: 6px;">
                                <path d="M288 32c0-17.7-14.3-32-32-32s-32 14.3-32 32V274.7l-73.4-73.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l128 128c12.5 12.5 32.8 12.5 45.3 0l128-128c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L288 274.7V32zM64 352c-35.3 0-64 28.7-64 64v32c0 35.3 28.7 64 64 64H448c35.3 0 64-28.7 64-64V416c0-35.3-28.7-64-64-64H346.5l-45.3 45.3c-25 25-65.5 25-90.5 0L165.5 352H64zm368 56a24 24 0 1 1 0 48 24 24 0 1 1 0-48z" />
                            </svg>
                            Export Clients
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    function openTab(evt, tabName) {
        // Declare variables
        var i, tabcontent, tablinks;

        // Get all elements with class="tab-content" and hide them
        tabcontent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].classList.remove("active");
        }

        // Get all elements with class="tab-btn" and remove the class "active"
        tablinks = document.getElementsByClassName("tab-btn");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].classList.remove("active");
            tablinks[i].setAttribute("aria-selected", "false");
        }

        // Show the current tab, and add an "active" class to the button that opened the tab
        document.getElementById(tabName).classList.add("active");
        evt.currentTarget.classList.add("active");
        evt.currentTarget.setAttribute("aria-selected", "true");
    }
</script>

<?=template_admin_footer()?>
                </form>
            </div>
        </div>
        <!-- Nav tabs -->
        <ul class="nav nav-tabs" id="transferTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="export-clients-tab" data-bs-toggle="tab" data-bs-target="#export-clients" type="button" role="tab" aria-controls="export-clients" aria-selected="true">
                    <svg width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" style="margin-right: 6px;">
                        <path d="M288 32c0-17.7-14.3-32-32-32s-32 14.3-32 32V274.7l-73.4-73.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l128 128c12.5 12.5 32.8 12.5 45.3 0l128-128c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L288 274.7V32zM64 352c-35.3 0-64 28.7-64 64v32c0 35.3 28.7 64 64 64H448c35.3 0 64-28.7 64-64V416c0-35.3-28.7-64-64-64H346.5l-45.3 45.3c-25 25-65.5 25-90.5 0L165.5 352H64zm368 56a24 24 0 1 1 0 48 24 24 0 1 1 0-48z" />
                    </svg>
                    Export Clients
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="import-clients-tab" data-bs-toggle="tab" data-bs-target="#import-clients" type="button" role="tab" aria-controls="import-clients" aria-selected="false">
                    <svg width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" style="margin-right: 6px;">
                        <path d="M288 109.3V352c0 17.7-14.3 32-32 32s-32-14.3-32-32V109.3l-73.4 73.4c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3l128-128c12.5-12.5 32.8-12.5 45.3 0l128 128c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L288 109.3zM64 352H192c0 35.3 28.7 64 64 64s64-28.7 64-64H448c35.3 0 64 28.7 64 64v32c0 35.3 28.7 64 64 64H64c-35.3 0-64-28.7-64-64V416c0-35.3 28.7-64 64-64zM432 456a24 24 0 1 0 0-48 24 24 0 1 0 0 48z" />
                    </svg>
                    Import Clients
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="export-collections-tab" data-bs-toggle="tab" data-bs-target="#export-collections" type="button" role="tab" aria-controls="export-collections" aria-selected="false">
                    <svg width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" style="margin-right: 6px;">
                        <path d="M288 32c0-17.7-14.3-32-32-32s-32 14.3-32 32V274.7l-73.4-73.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l128 128c12.5 12.5 32.8 12.5 45.3 0l128-128c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L288 274.7V32zM64 352c-35.3 0-64 28.7-64 64v32c0 35.3 28.7 64 64 64H448c35.3 0 64-28.7 64-64V416c0-35.3-28.7-64-64-64H346.5l-45.3 45.3c-25 25-65.5 25-90.5 0L165.5 352H64zm368 56a24 24 0 1 1 0 48 24 24 0 1 1 0-48z" />
                    </svg>
                    Export Collections
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="import-collections-tab" data-bs-toggle="tab" data-bs-target="#import-collections" type="button" role="tab" aria-controls="import-collections" aria-selected="false">
                    <svg width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" style="margin-right: 6px;">
                        <path d="M288 109.3V352c0 17.7-14.3 32-32 32s-32-14.3-32-32V109.3l-73.4 73.4c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3l128-128c12.5-12.5 32.8-12.5 45.3 0l128 128c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L288 109.3zM64 352H192c0 35.3 28.7 64 64 64s64-28.7 64-64H448c35.3 0 64 28.7 64 64v32c0 35.3 28.7 64 64 64H64c-35.3 0-64-28.7-64-64V416c0-35.3 28.7-64 64-64zM432 456a24 24 0 1 0 0-48 24 24 0 1 0 0 48z" />
                    </svg>
                    Import Collections
                </button>
            </li>
        </ul>

        <!-- Tab panes -->
        <div class="tab-content" id="transferTabContent" style="margin-top: 10px; min-height: 300px;">
            
            <!-- Export Clients Tab -->
            <div class="tab-pane show active" id="export-clients" role="tabpanel" aria-labelledby="export-clients-tab">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="clients_export_type" class="form-label">
                                <span class="required" aria-hidden="true">*</span> 
                                File Format
                                <span class="sr-only">(required)</span>
                            </label>
                            <select class="form-control" id="clients_export_type" name="clients_export_type" required>
                                <option value="csv">CSV (Comma Separated Values)</option>
                                <option value="txt">TXT (Text File)</option>
                                <option value="json">JSON (JavaScript Object Notation)</option>
                                <option value="xml">XML (Extensible Markup Language)</option>
                            </select>
                            <div class="form-text">Choose the format for your exported clients data file.</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="file-info" role="region" aria-labelledby="clients-export-info">
                            <h6 id="clients-export-info">Export Information</h6>
                            <p>Download all client data including contact information, invoices, and billing details in your preferred format.</p>
                            <ul>
                                <li><strong>CSV:</strong> Spreadsheet-compatible format</li>
                                <li><strong>JSON:</strong> Machine-readable data format</li>
                                <li><strong>XML:</strong> Structured markup format</li>
                                <li><strong>TXT:</strong> Plain text format</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="d-flex gap-2 pt-3 border-top mt-4">
                    <a href="invoices.php" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1" aria-hidden="true"></i>Cancel
                    </a>
                    <button type="submit" name="submit" class="btn btn-success">
                        <i class="fas fa-download me-1" aria-hidden="true"></i>Export Clients
                    </button>
                </div>
            </div>

            <!-- Import Clients Tab -->
            <div class="tab-pane" id="import-clients" role="tabpanel" aria-labelledby="import-clients-tab">
                <div class="row">
                    <div class="col-md-6">
                        <?php if (isset($_SESSION['clients_upload_success']) && $_SESSION['clients_upload_success']): ?>
                            <div class="alert alert-success alert-dismissible fade show" role="alert">
                                <i class="fas fa-check-circle me-2" aria-hidden="true"></i>
                                Clients data uploaded successfully! The file has been processed and your client data has been imported.
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        <?php endif; ?>
                        
                        <div class="mb-3">
                            <label for="clients_file" class="form-label">
                                <span class="required" aria-hidden="true">*</span> 
                                Data File
                                <span class="sr-only">(required)</span>
                            </label>
                            <input type="file" class="form-control" name="clients_file" id="clients_file" accept=".csv,.json,.xml,.txt" required>
                            <div class="form-text">Select a data file to import clients information.</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="file-info" role="region" aria-labelledby="clients-import-info">
                            <h6 id="clients-import-info">Supported File Formats</h6>
                            <ul>
                                <li><strong>CSV:</strong> Comma-separated values with header row</li>
                                <li><strong>JSON:</strong> Array of clients objects</li>
                                <li><strong>XML:</strong> Structured XML with clients elements</li>
                                <li><strong>TXT:</strong> Tab or comma-delimited text file</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="d-flex gap-2 pt-3 border-top mt-4">
                    <a href="invoices.php" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1" aria-hidden="true"></i>Cancel
                    </a>
                    <button type="submit" name="clients_import" class="btn btn-success">
                        <i class="fas fa-upload me-1" aria-hidden="true"></i>Import Clients
                    </button>
                </div>
            </div>

            <!-- Export Collections Tab -->
            <div class="tab-pane" id="export-collections" role="tabpanel" aria-labelledby="export-collections-tab">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="collections_export_type" class="form-label">
                                <span class="required" aria-hidden="true">*</span> 
                                File Format
                                <span class="sr-only">(required)</span>
                            </label>
                            <select class="form-control" id="collections_export_type" name="collections_export_type" required>
                                <option value="csv">CSV (Comma Separated Values)</option>
                                <option value="txt">TXT (Text File)</option>
                                <option value="json">JSON (JavaScript Object Notation)</option>
                                <option value="xml">XML (Extensible Markup Language)</option>
                            </select>
                            <div class="form-text">Choose the format for your exported collections data file.</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="file-info" role="region" aria-labelledby="collections-export-info">
                            <h6 id="collections-export-info">Export Information</h6>
                            <p>Download all collection data including invoice collections, payment schedules, and collection status information in your preferred format.</p>
                            <ul>
                                <li><strong>CSV:</strong> Spreadsheet-compatible format</li>
                                <li><strong>JSON:</strong> Machine-readable data format</li>
                                <li><strong>XML:</strong> Structured markup format</li>
                                <li><strong>TXT:</strong> Plain text format</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="d-flex gap-2 pt-3 border-top mt-4">
                    <a href="invoices.php" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1" aria-hidden="true"></i>Cancel
                    </a>
                    <button type="submit" name="submit" class="btn btn-success">
                        <i class="fas fa-download me-1" aria-hidden="true"></i>Export Collections
                    </button>
                </div>
            </div>

            <!-- Import Collections Tab -->
            <div class="tab-pane" id="import-collections" role="tabpanel" aria-labelledby="import-collections-tab">
                <div class="row">
                    <div class="col-md-6">
                        <?php if (isset($_SESSION['collections_upload_success']) && $_SESSION['collections_upload_success']): ?>
                            <div class="alert alert-success alert-dismissible fade show" role="alert">
                                <i class="fas fa-check-circle me-2" aria-hidden="true"></i>
                                Collections data uploaded successfully! The file has been processed and your collection data has been imported.
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        <?php endif; ?>
                        
                        <div class="mb-3">
                            <label for="invoice_file" class="form-label">
                                <span class="required" aria-hidden="true">*</span> 
                                Data File
                                <span class="sr-only">(required)</span>
                            </label>
                            <input type="file" class="form-control" name="invoice_file" id="invoice_file" accept=".csv,.json,.xml,.txt" required>
                            <div class="form-text">Select a data file to import collections information.</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="file-info" role="region" aria-labelledby="collections-import-info">
                            <h6 id="collections-import-info">Supported File Formats</h6>
                            <ul>
                                <li><strong>CSV:</strong> Comma-separated values with header row</li>
                                <li><strong>JSON:</strong> Array of collections objects</li>
                                <li><strong>XML:</strong> Structured XML with collections elements</li>
                                <li><strong>TXT:</strong> Tab or comma-delimited text file</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="d-flex gap-2 pt-3 border-top mt-4">
                    <a href="invoices.php" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1" aria-hidden="true"></i>Cancel
                    </a>
                    <button type="submit" name="collections_import" class="btn btn-success">
                        <i class="fas fa-upload me-1" aria-hidden="true"></i>Import Collections
                    </button>
                </div>
            </div>
        </div>
                                <li><strong>XML:</strong> Structured XML with clients elements</li>
                                <li><strong>TXT:</strong> Tab or comma-delimited text file</li>
                            </ul>
                        </div>
                    </fieldset>
                    
                    <div class="d-flex gap-2 mt-4">
                        <button type="submit" name="clients_import" class="btn btn-success">
                            <i class="fas fa-upload me-1"></i>Import Clients
                        </button>
                        <a href="invoices.php" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-1"></i>Cancel
                        </a>
                    </div>
                </form>
            </div>

            <!-- Export Collections Tab -->
            <div class="tab-pane fade" id="export-collections" role="tabpanel" aria-labelledby="export-collections-tab">
                <form action="" method="post" role="form">
                    <fieldset>
                        <legend class="h5 mb-3">Export Collections Data</legend>
                        <p class="text-muted mb-4">Download all clients collections data in your preferred format.</p>

                        <div class="mb-3">
                            <label for="collections_export_type" class="form-label">
                                <span class="text-danger">*</span> File Type
                            </label>
                            <select id="collections_export_type" name="collections_export_type" class="form-select" required>
                                <option value="csv">CSV (Comma Separated Values)</option>
                                <option value="txt">TXT (Text File)</option>
                                <option value="json">JSON (JavaScript Object Notation)</option>
                                <option value="xml">XML (Extensible Markup Language)</option>
                            </select>
                            <div class="form-text">Choose the format for your exported collections data file.</div>
                        </div>
                    </fieldset>
                    
                    <div class="d-flex gap-2 mt-4">
                        <button type="submit" name="submit" class="btn btn-success">
                            <i class="fas fa-download me-1"></i>Export Collections
                        </button>
                        <a href="invoices.php" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-1"></i>Cancel
                        </a>
                    </div>
                </form>
            </div>

            <!-- Import Collections Tab -->
            <div class="tab-pane fade" id="import-collections" role="tabpanel" aria-labelledby="import-collections-tab">
                <form action="" method="post" enctype="multipart/form-data" role="form">
                    <fieldset>
                        <legend class="h5 mb-3">Import Collections Data</legend>
                        <p class="text-muted mb-4">Upload a file containing clients collections data to import into the system.</p>

                        <div class="mb-3">
                            <label for="invoice_file" class="form-label">
                                <span class="text-danger">*</span> File Upload
                            </label>
                            <input type="file" name="invoice_file" id="invoice_file" class="form-control" accept=".csv,.json,.xml,.txt" required>
                            <div class="form-text">Select a data file to import collections information.</div>
                        </div>

                        <div class="alert alert-info">
                            <h6 class="alert-heading">Supported File Formats</h6>
                            <ul class="mb-0 small">
                                <li><strong>CSV:</strong> Comma-separated values with header row</li>
                                <li><strong>JSON:</strong> Array of collections objects</li>
                                <li><strong>XML:</strong> Structured XML with collections elements</li>
                                <li><strong>TXT:</strong> Tab or comma-delimited text file</li>
                            </ul>
                        </div>
                    </fieldset>
                    
                    <div class="d-flex gap-2 mt-4">
                        <button type="submit" name="collections_import" class="btn btn-success">
                            <i class="fas fa-upload me-1"></i>Import Collections
                        </button>
                        <a href="invoices.php" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-1"></i>Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Manual tab handling as backup
document.addEventListener('DOMContentLoaded', function() {
    // Get all tab buttons
    const tabButtons = document.querySelectorAll('[data-bs-toggle="tab"]');
    const tabPanes = document.querySelectorAll('.tab-pane');
    
    // Function to show a specific tab
    function showTab(targetId) {
        // Hide all tab panes
        tabPanes.forEach(pane => {
            pane.style.display = 'none';
            pane.classList.remove('active', 'show');
        });
        
        // Remove active class from all buttons
        tabButtons.forEach(btn => {
            btn.classList.remove('active');
            btn.setAttribute('aria-selected', 'false');
        });
        
        // Show target tab pane
        const targetPane = document.getElementById(targetId);
        if (targetPane) {
            targetPane.style.display = 'block';
            targetPane.classList.add('active', 'show');
        }
        
        // Mark button as active
        const activeButton = document.querySelector(`[data-bs-target="#${targetId}"]`);
        if (activeButton) {
            activeButton.classList.add('active');
            activeButton.setAttribute('aria-selected', 'true');
        }
    }
    
    // Add click handlers to all tab buttons
    tabButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const target = this.getAttribute('data-bs-target');
            if (target) {
                const targetId = target.replace('#', '');
                showTab(targetId);
            }
        });
    });
    
    // Show the first tab by default
    showTab('export-clients');
});
</script>

<?=template_admin_footer()?>
